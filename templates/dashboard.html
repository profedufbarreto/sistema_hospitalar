<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | PEP Profissional</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .theme-icon-minimal {
            font-family: "Segoe UI Symbol", "Symbola", "DejaVu Sans", sans-serif;
            font-weight: 100;
            user-select: none;
            display: inline-block;
            transition: color 0.3s ease;
        }
        
        #theme-toggle {
            outline: none;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        #theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.05) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        .nav-link {
            text-decoration: none;
            color: inherit;
            font-size: 0.95rem;
            transition: opacity 0.2s;
        }

        .nav-link:hover { opacity: 0.7; }

        .nav-link.active {
            color: #61afef;
            font-weight: bold;
        }

        .chart-wrapper {
            position: relative;
            height: 250px;
            width: 100%;
        }
    </style>
</head>
<body class="dark-mode">
    
    <header class="main-header" style="background: #181a1f; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;">
        <h2>üìä PEP <span style="font-weight: 100; opacity: 0.6;">| Dashboard</span></h2>
        
        <nav style="display: flex; align-items: center; gap: 20px;">
            <button id="theme-toggle" class="theme-toggle-btn" title="Alternar Modo de Cor" 
                    style="background: none; border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; padding: 0; border-radius: 8px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; transition: 0.3s;">
                <span id="theme-icon" class="theme-icon-minimal" style="font-size: 1.2rem;"></span>
            </button>

            <a href="{{ url_for('dashboard') }}" class="nav-link active">Home</a>
            <a href="{{ url_for('sistema') }}" class="nav-link">Sistema</a>
            <a href="{{ url_for('logout') }}" style="color: #e06c75; font-weight: bold; text-decoration: none;" class="nav-link">Sair</a>
        </nav>
    </header>

    <main class="dashboard-content" style="padding: 20px;">
        <section class="kpi-cards">
            <div class="card card-internados">
                <h4>ü©∫ Internados Atuais</h4>
                <p class="kpi-value">{{ dados.total_internados }}</p>
                <div style="text-align: center;"><small>üëÅÔ∏è Detalhes no Prontu√°rio</small></div>
            </div>
            
            <div class="card card-altas">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4>‚úÖ Altas</h4>
                    <select class="kpi-filter-white" onchange="updateKpi('altas', this.value)">
                        <option value="7d">7 dias</option>
                        <option value="15d">15 dias</option>
                        <option value="30d">30 dias</option>
                        <option value="trimestre">1 trimestre</option>
                        <option value="semestre">1 semestre</option>
                    </select>
                </div>
                <p class="kpi-value" id="kpi-altas-val">{{ dados.altas_ultimos_7_dias }}</p>
            </div>

            <div class="card card-estoque">
                <h4>üì¶ Baixo Estoque</h4>
                <p class="kpi-value">{{ dados.baixo_estoque }}</p>
                <div class="stock-progress">
                    <div class="stock-bar" style="width: {{ dados.baixo_estoque }}%; background: white; height: 4px; border-radius: 2px;"></div>
                </div>
            </div>

            <div class="card card-pv">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h4>‚ù§Ô∏è Provas de Vida</h4>
                    <select class="kpi-filter-white" onchange="updateKpi('pv', this.value)">
                        <option value="24h">24h</option>
                        <option value="48h">48h</option>
                        <option value="92h">92h</option>
                    </select>
                </div>
                <p class="kpi-value" id="kpi-pv-val">{{ dados.provas_vida_ultimas_24h }}</p>
                <a href="{{ url_for('provas_vida_geral') }}" class="btn-view-more">üîç Ver Hist√≥rico</a>
            </div>
        </section>

        <section class="charts-grid">
            <div class="chart-container-small">
                <div class="chart-header">
                    <h3>üìà Fluxo Mensal</h3>
                    <div class="chart-controls">
                        <button onclick="toggleLine(0)">Entradas</button>
                        <button onclick="toggleLine(1)">Altas</button>
                    </div>
                </div>
                <div class="chart-wrapper"><canvas id="mensalChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>‚≠ï Prioridade Ativa (Internados)</h3>
                <div class="chart-wrapper"><canvas id="prioridadeChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>üìä Dias M√©dios / Profissional</h3>
                <div class="chart-wrapper"><canvas id="diasChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>üìÖ Comparativo Anual</h3>
                <div class="chart-wrapper"><canvas id="anualChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>‚≠ï Distribui√ß√£o Anual de Triagem</h3>
                <div class="chart-wrapper"><canvas id="tendenciaChart"></canvas></div>
            </div>
        </section>
    </main>

    <script>
        const d = {{ dados|tojson }};
        let mensalChart;

        Chart.defaults.color = '#abb2bf';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';
        
        // Cores diversificadas para os profissionais
        const professionalColors = ['#61afef', '#98c379', '#e5c07b', '#c678dd', '#e06c75', '#56b6c2', '#d19a66'];

        // 1. Gr√°fico Mensal
        mensalChart = new Chart(document.getElementById('mensalChart'), {
            type: 'line',
            data: {
                labels: d.movimentacao_mensal.labels,
                datasets: [
                    { label: 'Entradas', data: d.movimentacao_mensal.entradas, borderColor: '#61afef', tension: 0.4, fill: false },
                    { label: 'Altas', data: d.movimentacao_mensal.altas, borderColor: '#98c379', tension: 0.4, fill: false }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        function toggleLine(index) {
            const meta = mensalChart.getDatasetMeta(index);
            meta.hidden = meta.hidden === null ? !mensalChart.data.datasets[index].hidden : null;
            mensalChart.update();
        }

        // 2. Prioridade Atual
        new Chart(document.getElementById('prioridadeChart'), {
            type: 'doughnut',
            data: {
                labels: d.prioridade_data.labels,
                datasets: [{ data: d.prioridade_data.data, backgroundColor: ['#98c379', '#e5c07b', '#e06c75'], borderWidth: 0 }]
            },
            options: { cutout: '75%', responsive: true, maintainAspectRatio: false }
        });

        // 3. Dias M√©dios / Profissional (Cores diferentes por coluna)
        new Chart(document.getElementById('diasChart'), {
            type: 'bar',
            data: {
                labels: d.dias_data.labels || [],
                datasets: [{ 
                    label: 'M√©dia de Dias', 
                    data: d.dias_data.data || [], 
                    backgroundColor: professionalColors, 
                    borderRadius: 5 
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // 4. Hist√≥rico Anual
        new Chart(document.getElementById('anualChart'), {
            type: 'bar',
            data: {
                labels: d.movimentacao_anual.labels,
                datasets: [
                    { label: 'Entradas', data: d.movimentacao_anual.entradas, backgroundColor: '#61afef', borderRadius: 4 },
                    { label: 'Altas', data: d.movimentacao_anual.altas, backgroundColor: '#98c379', borderRadius: 4 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // 5. Distribui√ß√£o Anual de Triagem (Rosca Acumulada)
        new Chart(document.getElementById('tendenciaChart'), {
            type: 'doughnut',
            data: {
                labels: ['Verde', 'Amarelo', 'Vermelho'],
                datasets: [{
                    label: 'Total Acumulado',
                    data: [
                        d.prioridade_tendencia.verde.reduce((a, b) => a + b, 0),
                        d.prioridade_tendencia.amarelo.reduce((a, b) => a + b, 0),
                        d.prioridade_tendencia.vermelho.reduce((a, b) => a + b, 0)
                    ],
                    backgroundColor: ['#98c379', '#e5c07b', '#e06c75'],
                    borderWidth: 0,
                    hoverOffset: 15
                }]
            },
            options: { 
                cutout: '70%', 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.parsed;
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = ((value * 100) / total).toFixed(1) + "%";
                                return `${label}: ${value} (${percentage})`;
                            }
                        }
                    }
                }
            }
        });

        // Atualiza√ß√£o Din√¢mica via API
        function updateKpi(t, p) {
            fetch(`/api/kpi/${t}/${p}`).then(res => res.json()).then(data => {
                const el = document.getElementById(`kpi-${t}-val`);
                if(el) {
                    el.style.opacity = 0;
                    setTimeout(() => {
                        el.innerText = data.valor;
                        el.style.opacity = 1;
                    }, 150);
                }
            });
        }

        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        function refreshUI(isDark) {
            document.body.classList.toggle('dark-mode', isDark);
            themeIcon.innerHTML = isDark ? '&#9728;' : '&#9789;';
            themeIcon.style.color = isDark ? '#ffcc00' : '#333';
        }

        const savedTheme = localStorage.getItem('theme') || 'dark';
        refreshUI(savedTheme === 'dark');

        themeToggle.addEventListener('click', () => {
            const isNowDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isNowDark ? 'dark' : 'light');
            refreshUI(isNowDark);
        });
    </script>
</body>
</html>