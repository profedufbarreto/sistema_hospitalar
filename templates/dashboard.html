<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | PEP</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    
    <header class="main-header">
        <h2>Bem-vindo(a), {{ usuario }} ({{ nivel | upper }})</h2>
        <nav>
            <a href="{{ url_for('dashboard') }}" class="active">Dashboard</a>
            <a href="{{ url_for('prontuario') }}">Prontu√°rio</a>
            <a href="{{ url_for('pacientes') }}">Pacientes</a> 
            <a href="{{ url_for('estoque') }}">Estoque</a>
            <a href="{{ url_for('conversor') }}">Conversor</a>
            <a href="{{ url_for('arquivo') }}">Arquivo</a>
            
            {% if nivel in ['admin', 'tecnico'] %}
                <a href="{{ url_for('gerenciar_usuarios') }}">Usu√°rios</a>
            {% endif %}
            
            <a href="{{ url_for('logout') }}" class="btn-logout">Sair</a>
        </nav>
    </header>
    
    <main class="dashboard-content">
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <section class="kpi-cards">
            <div class="card card-internados">
                <h4>ü©∫ Internados Atuais</h4>
                <p class="kpi-value">{{ dados.total_internados }}</p> 
            </div>
            
            <div class="card card-altas">
                <h4>‚úÖ Altas (√öltimos 7 dias)</h4>
                <p class="kpi-value">{{ dados.altas_ultimos_7_dias }}</p> 
            </div>

            <div class="card card-estoque">
                <h4>üì¶ Baixo Estoque (< 100 un)</h4>
                <p class="kpi-value {% if dados.baixo_estoque > 0 %}kpi-alerta{% endif %}">
                    {{ dados.baixo_estoque }}
                </p> 
            </div>

            <div class="card card-pv">
                <h4>‚ù§Ô∏è Provas de Vida (24h)</h4>
                <p class="kpi-value">{{ dados.provas_vida_ultimas_24h }}</p> 
            </div>
        </section>

        <hr>

        <section class="charts-full-width">
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Movimenta√ß√£o de Pacientes (Entradas vs. Altas)</h3>
                    <div class="filter-controls">
                        <button class="btn-filter active" data-filter="mensal">Mensal (Ano Atual)</button>
                        <button class="btn-filter" data-filter="anual">Anual (√öltimos 5 Anos)</button>
                    </div>
                </div>
                <canvas id="movimentacaoChart" height="90"></canvas>
            </div>
        </section>

        <section class="dashboard-visuals">
            
            <div class="charts-analysis">
                
                <div class="chart-half">
                    <div class="chart-header" style="flex-direction: column; align-items: center;">
                        <h3 style="margin: 0; padding-top: 10px;">Distribui√ß√£o de Pacientes por Prioridade (Atual)</h3>
                    </div>
                    <canvas id="prioridadeChart"></canvas>
                    <p id="prioridadeMessage" style="text-align: center; color: #777; margin-top: 10px; display: none;">N√£o h√° interna√ß√µes ativas com triagem definida.</p>
                </div>
                
                <div class="chart-half">
                    <h3>Dias M√©dios de Interna√ß√£o (Profissionais de Alta)</h3>
                    <canvas id="diasChart"></canvas>
                </div>
            </div>
            
            <div class="info-painel">
                <h3>Painel de A√ß√µes R√°pidas</h3>
                
                <div class="info-block">
                    <h4>Pr√≥ximos Passos</h4>
                    <ul>
                        <li><a href="{{ url_for('pacientes') }}">Revisar Sinais Vitais (PV)</a></li>
                        {% if dados.total_internados > 0 %}
                            <li><a href="{{ url_for('pacientes') }}" style="font-weight: bold;">Gerenciar {{ dados.total_internados }} Pacientes Internados</a></li>
                        {% else %}
                            <li>Nenhum paciente internado atualmente.</li>
                        {% endif %}
                        {% if dados.baixo_estoque > 0 %}
                            <li style="color: #dc3545;">‚ö†Ô∏è <a href="{{ url_for('estoque') }}">Reabastecer {{ dados.baixo_estoque }} itens em baixo estoque!</a></li>
                        {% endif %}
                    </ul>
                </div>
                
                <div class="info-block">
                    <h4>Acesso R√°pido</h4>
                    <a href="{{ url_for('prontuario') }}" class="btn-full-width" style="background-color: #007bff;">‚ûï Registrar Nova Interna√ß√£o</a>
                    <a href="{{ url_for('estoque') }}" class="btn-full-width" style="background-color: #ffc107;">üì¶ Gerenciar Estoque</a>
                </div>
                
            </div>
        </section>
        
        <hr style="margin-top: 40px; margin-bottom: 40px;">

        <section class="charts-full-width">
            <div class="chart-container">
                <div class="chart-header">
                    <h3 style="width: 100%; margin-bottom: 10px;">Tend√™ncia Mensal de Interna√ß√µes por Prioridade (Ano Atual)</h3>
                </div>
                
                <canvas id="tendenciaPrioridadeChart" height="80"></canvas>
                <p id="tendenciaPrioridadeMessage" style="text-align: center; color: #777; margin-top: 10px; display: none;">N√£o h√° dados de tend√™ncia para o per√≠odo.</p>
            </div>
        </section>

    </main>
    
    <script>
        const FLASK_DASHBOARD_DATA = {{ dados|tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>