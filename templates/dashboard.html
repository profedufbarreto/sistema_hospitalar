<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | PEP</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    
    <header class="main-header">
        <h2>Dashboard | PEP</h2> 
        <nav style="display: flex; align-items: center;">
            <div class="theme-switcher">
                <input type="checkbox" id="theme-toggle" title="Alternar Modo de Visualiza√ß√£o">
                <label for="theme-toggle" class="theme-icon-label"></label>
            </div>
            
            <a href="{{ url_for('dashboard') }}" class="active">Dashboard</a>
            <a href="{{ url_for('prontuario') }}">Prontu√°rio</a>
            <a href="{{ url_for('pacientes') }}">Pacientes</a> 
            <a href="{{ url_for('estoque') }}">Estoque</a>
            <a href="{{ url_for('conversor') }}">Conversor</a> 
            <a href="{{ url_for('arquivo') }}">Arquivo</a> 
            
            {% if session.get('nivel') in ['admin', 'tecnico'] %}
                <a href="{{ url_for('gerenciar_usuarios') }}">Usu√°rios</a>
            {% endif %}
            
            <a href="{{ url_for('logout') }}" class="btn-logout">Sair</a>
        </nav>
    </header>

    <main class="dashboard-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <section class="kpi-cards">
            <div class="card card-internados">
                <h4>ü©∫ Internados Atuais</h4>
                <p class="kpi-value">{{ dados.total_internados }}</p> 
            </div>
            
            <div class="card card-altas">
                <div class="card-header-kpi">
                    <h4>‚úÖ Altas</h4>
                    <select class="kpi-filter" onchange="updateKpi('altas', this.value)">
                        <option value="7d">√öltimos 7 dias</option>
                        <option value="15d">√öltimos 15 dias</option>
                        <option value="30d">√öltimos 30 dias</option>
                        <option value="trimestre">√öltimo Trimestre</option>
                        <option value="semestre">√öltimo Semestre</option>
                        <option value="ano">√öltimo Ano</option>
                    </select>
                </div>
                <p class="kpi-value" id="kpi-altas-val">{{ dados.altas_ultimos_7_dias }}</p> 
            </div>

            <div class="card card-estoque">
                <h4>üì¶ Baixo Estoque</h4>
                <p class="kpi-value {% if dados.baixo_estoque > 0 %}kpi-alerta{% endif %}">{{ dados.baixo_estoque }}</p> 
            </div>

            <div class="card card-pv">
                <div class="card-header-kpi">
                    <h4>‚ù§Ô∏è Provas de Vida</h4>
                    <select class="kpi-filter" onchange="updateKpi('pv', this.value)">
                        <option value="24h">√öltimas 24h</option>
                        <option value="48h">√öltimas 48h</option>
                        <option value="92h">√öltimas 92h</option>
                    </select>
                </div>
                <p class="kpi-value" id="kpi-pv-val">{{ dados.provas_vida_ultimas_24h }}</p> 
                <div style="text-align: center; margin-top: 10px;">
                    <a href="{{ url_for('provas_vida_geral') }}" style="color: #007bff; text-decoration: none; font-size: 0.85em; font-weight: bold;">
                        üîç Ver Hist√≥rico Geral
                    </a>
                </div>
            </div>
        </section>

        <hr>

        <section class="charts-grid">
            <div class="chart-container-small">
                <h3>üìä Movimenta√ß√£o Mensal</h3>
                <div class="chart-wrapper"><canvas id="mensalChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>üìå Prioridade Atual</h3>
                <div class="chart-wrapper"><canvas id="prioridadeChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>‚è≥ Dias M√©dios / Profissional</h3>
                <div class="chart-wrapper"><canvas id="diasChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>üìÖ Hist√≥rico Anual</h3>
                <div class="chart-wrapper"><canvas id="anualChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>üìà Tend√™ncia de Prioridade</h3>
                <div class="chart-wrapper"><canvas id="tendenciaChart"></canvas></div>
            </div>
        </section>
    </main>

    <script>
        const d = {{ dados|tojson }};
        
        const commonOptions = { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } }
        };

        // 1. Gr√°fico de Movimenta√ß√£o Mensal
        new Chart(document.getElementById('mensalChart'), {
            type: 'line',
            data: {
                labels: d.movimentacao_mensal.labels,
                datasets: [
                    { label: 'Entradas', data: d.movimentacao_mensal.entradas, borderColor: '#007bff', tension: 0.3, fill: false },
                    { label: 'Altas', data: d.movimentacao_mensal.altas, borderColor: '#28a745', tension: 0.3, fill: false }
                ]
            },
            options: commonOptions
        });

        // 2. Gr√°fico de Prioridade
        new Chart(document.getElementById('prioridadeChart'), {
            type: 'doughnut',
            data: {
                labels: d.prioridade_data.labels,
                datasets: [{ 
                    data: d.prioridade_data.data, 
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'] 
                }]
            },
            options: commonOptions
        });

        // 3. Gr√°fico de Dias M√©dios
        new Chart(document.getElementById('diasChart'), {
            type: 'bar',
            data: {
                labels: d.dias_data.labels || [],
                datasets: [{ label: 'M√©dia de Dias', data: d.dias_data.data || [], backgroundColor: '#20b2aa' }]
            },
            options: { ...commonOptions, indexAxis: 'y' }
        });

        // 4. Gr√°fico de Hist√≥rico Anual
        new Chart(document.getElementById('anualChart'), {
            type: 'bar',
            data: {
                labels: d.movimentacao_anual.labels || [],
                datasets: [
                    { label: 'Entradas', data: d.movimentacao_anual.entradas || [], backgroundColor: '#007bff' },
                    { label: 'Altas', data: d.movimentacao_anual.altas || [], backgroundColor: '#28a745' }
                ]
            },
            options: commonOptions
        });

        // 5. Tend√™ncia de Prioridade
        new Chart(document.getElementById('tendenciaChart'), {
            type: 'line',
            data: {
                labels: d.movimentacao_mensal.labels,
                datasets: [
                    { label: 'Verde', data: d.prioridade_tendencia.verde, borderColor: '#28a745', fill: false },
                    { label: 'Amarelo', data: d.prioridade_tendencia.amarelo, borderColor: '#ffc107', fill: false },
                    { label: 'Vermelho', data: d.prioridade_tendencia.vermelho, borderColor: '#dc3545', fill: false }
                ]
            },
            options: commonOptions
        });

        function updateKpi(t, p) {
            fetch(`/api/kpi/${t}/${p}`).then(r => r.json()).then(data => {
                document.getElementById(`kpi-${t}-val`).innerText = data.valor;
            }).catch(err => console.error("Erro ao atualizar KPI:", err));
        }

        // --- CONTROLE DE TEMA ---
        function updateThemeIcon() {
            const toggle = document.getElementById('theme-toggle');
            const label = document.querySelector('.theme-icon-label');
            if (toggle && label) {
                label.setAttribute('data-icon', toggle.checked ? 'üåû' : 'üåô');
            }
        }

        function initTheme() {
            const toggle = document.getElementById('theme-toggle');
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                if(toggle) toggle.checked = true;
            }
            updateThemeIcon();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            const toggle = document.getElementById('theme-toggle');
            if (toggle) {
                toggle.addEventListener('change', toggleTheme);
            }
        });
    </script>
</body>
</html>