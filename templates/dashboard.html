<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | PEP</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Ajustes de layout para economia de espa√ßo */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container-small {
            background-color: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px var(--shadow-color);
            border: 1px solid var(--border-color);
        }
        .chart-container-small h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            text-align: center;
            color: var(--text-primary);
        }
        canvas { max-width: 100%; }
    </style>
</head>
<body>
    
    <header class="main-header">
        <h2>Dashboard | PEP</h2> 
        <nav style="display: flex; align-items: center;">
            <div class="theme-switcher">
                <input type="checkbox" id="theme-toggle" title="Alternar Modo de Visualiza√ß√£o">
                <label for="theme-toggle" class="theme-icon-label"></label>
            </div>
        
            <a href="{{ url_for('dashboard') }}" class="active">Dashboard</a>
            <a href="{{ url_for('prontuario') }}">Prontu√°rio</a>
            <a href="{{ url_for('pacientes') }}">Pacientes</a> 
            <a href="{{ url_for('estoque') }}">Estoque</a>
            <a href="{{ url_for('conversor') }}">Conversor</a> 
            <a href="{{ url_for('arquivo') }}">Arquivo</a> 
            
            {% if session.get('nivel') in ['admin', 'enfermeiro'] %}
                <a href="{{ url_for('gerenciar_usuarios') }}">Usu√°rios</a>
            {% endif %}
            
            <a href="{{ url_for('logout') }}" class="btn-logout">Sair</a>
        </nav>
    </header>

    <main class="dashboard-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <section class="kpi-cards">
            <div class="card card-internados">
                <h4>ü©∫ Internados Atuais</h4>
                <p class="kpi-value">{{ dados.total_internados }}</p> 
            </div>
            
            <div class="card card-altas">
                <div class="card-header-kpi">
                    <h4>‚úÖ Altas</h4>
                    <select class="kpi-filter" onchange="updateKpi('altas', this.value)">
                        <option value="7d">√öltimos 7 dias</option>
                        <option value="15d">√öltimos 15 dias</option>
                        <option value="1m">√öltimo M√™s</option>
                        <option value="1y">√öltimo Ano</option>
                    </select>
                </div>
                <p class="kpi-value" id="kpi-altas-val">{{ dados.altas_ultimos_7_dias }}</p> 
            </div>

            <div class="card card-estoque">
                <h4>üì¶ Baixo Estoque</h4>
                <p class="kpi-value {% if dados.baixo_estoque > 0 %}kpi-alerta{% endif %}">{{ dados.baixo_estoque }}</p> 
            </div>

            <div class="card card-pv">
                <div class="card-header-kpi">
                    <h4>‚ù§Ô∏è Provas de Vida</h4>
                    <select class="kpi-filter" onchange="updateKpi('pv', this.value)">
                        <option value="24h">√öltimas 24h</option>
                        <option value="48h">√öltimas 48h</option>
                        <option value="7d">√öltimos 7 dias</option>
                    </select>
                </div>
                <p class="kpi-value" id="kpi-pv-val">{{ dados.provas_vida_ultimas_24h }}</p> 
            </div>
        </section>

        <section class="charts-full-width">
            <div class="chart-container">
                <h3>üìä Movimenta√ß√£o Mensal (Entradas vs. Altas)</h3>
                <canvas id="mensalChart" height="70"></canvas>
            </div>
        </section>

        <section class="charts-grid">
            
            <div class="chart-container-small">
                <h3>üìå Distribui√ß√£o por Prioridade</h3>
                <canvas id="prioridadeChart"></canvas>
            </div>

            <div class="chart-container-small">
                <h3>‚è≥ M√©dia de Dias por Profissional</h3>
                <canvas id="diasChart"></canvas>
            </div>

            <div class="chart-container-small">
                <h3>üìÖ Hist√≥rico Anual</h3>
                <canvas id="anualChart"></canvas>
            </div>

            <div class="chart-container-small">
                <h3>üìà Tend√™ncia de Prioridade (Mensal)</h3>
                <canvas id="tendenciaChart"></canvas>
            </div>
        </section>

        <section class="dashboard-visuals" style="margin-top: 30px;">
            <div class="info-painel" style="width: 100%;">
                <h3>Painel de A√ß√µes R√°pidas</h3>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="info-block" style="flex: 1; min-width: 250px;">
                        <h4>Acesso R√°pido</h4>
                        <a href="{{ url_for('prontuario') }}" class="btn-full-width" style="background-color: #007bff;">‚ûï Nova Interna√ß√£o</a>
                        <a href="{{ url_for('estoque') }}" class="btn-full-width" style="background-color: #ffc107; color: #333;">üì¶ Estoque</a>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        const d = {{ dados|tojson }};

        // --- L√ìGICA DE TEMA ---
        function updateThemeIcon() {
            const toggle = document.getElementById('theme-toggle');
            const label = document.querySelector('.theme-icon-label');
            if (toggle && label) label.setAttribute('data-icon', toggle.checked ? 'üåû' : 'üåô');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById('theme-toggle');
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                if(toggle) toggle.checked = true;
            }
            updateThemeIcon();
            if(toggle) {
                toggle.addEventListener('change', () => {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                    updateThemeIcon();
                });
            }
        });

        // --- CONFIGURA√á√ÉO DOS 5 GR√ÅFICOS ---

        // 1. Mensal
        new Chart(document.getElementById('mensalChart'), {
            type: 'line',
            data: {
                labels: d.movimentacao_mensal.labels,
                datasets: [
                    { label: 'Entradas', data: d.movimentacao_mensal.entradas, borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.1)', fill: true },
                    { label: 'Altas', data: d.movimentacao_mensal.altas, borderColor: '#28a745', fill: false }
                ]
            },
            options: { responsive: true }
        });

        // 2. Prioridade (Rosca)
        new Chart(document.getElementById('prioridadeChart'), {
            type: 'doughnut',
            data: {
                labels: ['Verde', 'Amarelo', 'Vermelho'],
                datasets: [{ data: d.prioridade_data.data, backgroundColor: ['#28a745', '#ffc107', '#dc3545'] }]
            }
        });

        // 3. Dias M√©dios (Barras Horizontal)
        new Chart(document.getElementById('diasChart'), {
            type: 'bar',
            data: {
                labels: d.dias_data.labels,
                datasets: [{ label: 'Dias de Interna√ß√£o', data: d.dias_data.data, backgroundColor: '#20b2aa' }]
            },
            options: { indexAxis: 'y' }
        });

        // 4. Anual (Barras)
        new Chart(document.getElementById('anualChart'), {
            type: 'bar',
            data: {
                labels: d.movimentacao_anual.labels,
                datasets: [
                    { label: 'Entradas', data: d.movimentacao_anual.entradas, backgroundColor: '#007bff' },
                    { label: 'Altas', data: d.movimentacao_anual.altas, backgroundColor: '#28a745' }
                ]
            }
        });

        // 5. Tend√™ncia (Linhas)
        new Chart(document.getElementById('tendenciaChart'), {
            type: 'line',
            data: {
                labels: d.movimentacao_mensal.labels,
                datasets: [
                    { label: 'Verde', data: d.prioridade_tendencia.verde, borderColor: '#28a745', tension: 0.1 },
                    { label: 'Amarelo', data: d.prioridade_tendencia.amarelo, borderColor: '#ffc107', tension: 0.1 },
                    { label: 'Vermelho', data: d.prioridade_tendencia.vermelho, borderColor: '#dc3545', tension: 0.1 }
                ]
            }
        });

        // --- FUN√á√ÉO DE ATUALIZA√á√ÉO DE KPI ---
        function updateKpi(t, p) {
            const el = document.getElementById(`kpi-${t}-val`);
            el.style.opacity = "0.5";
            fetch(`/api/kpi/${t}/${p}`)
                .then(r => r.json())
                .then(data => {
                    el.innerText = data.valor;
                    el.style.opacity = "1";
                });
        }
    </script>
</body>
</html>