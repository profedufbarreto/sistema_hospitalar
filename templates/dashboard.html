<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | PEP</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    
    <header class="main-header">
        <h2>Dashboard | PEP</h2> 
        <nav style="display: flex; align-items: center;">
            <div class="theme-switcher">
                <input type="checkbox" id="theme-toggle" title="Alternar Modo de Visualiza√ß√£o">
                <label for="theme-toggle" class="theme-icon-label"></label>
            </div>
            <a href="{{ url_for('dashboard') }}" class="active">Dashboard</a>
            <a href="{{ url_for('prontuario') }}">Prontu√°rio</a>
            <a href="{{ url_for('pacientes') }}">Pacientes</a> 
            <a href="{{ url_for('estoque') }}">Estoque</a>
            <a href="{{ url_for('conversor') }}">Conversor</a> 
            <a href="{{ url_for('arquivo') }}">Arquivo</a> 
            {% if session.get('nivel') in ['admin', 'enfermeiro'] %}
                <a href="{{ url_for('gerenciar_usuarios') }}">Usu√°rios</a>
            {% endif %}
            <a href="{{ url_for('logout') }}" class="btn-logout">Sair</a>
        </nav>
    </header>

    <main class="dashboard-content">
        <section class="kpi-cards">
            <div class="card card-internados">
                <h4>ü©∫ Internados Atuais</h4>
                <p class="kpi-value">{{ dados.total_internados }}</p> 
            </div>
            
            <div class="card card-altas">
                <div class="card-header-kpi">
                    <h4>‚úÖ Altas</h4>
                    <select class="kpi-filter" onchange="updateKpi('altas', this.value)">
                        <option value="7d">√öltimos 7 dias</option>
                        <option value="1m">√öltimo M√™s</option>
                        <option value="1y">√öltimo Ano</option>
                    </select>
                </div>
                <p class="kpi-value" id="kpi-altas-val">{{ dados.altas_ultimos_7_dias }}</p> 
            </div>

            <div class="card card-estoque">
                <h4>üì¶ Baixo Estoque</h4>
                <p class="kpi-value {% if dados.baixo_estoque > 0 %}kpi-alerta{% endif %}">{{ dados.baixo_estoque }}</p> 
            </div>

            <div class="card card-pv">
                <div class="card-header-kpi">
                    <h4>‚ù§Ô∏è Provas de Vida</h4>
                    <select class="kpi-filter" onchange="updateKpi('pv', this.value)">
                        <option value="24h">√öltimas 24h</option>
                        <option value="7d">√öltimos 7 dias</option>
                    </select>
                </div>
                <p class="kpi-value" id="kpi-pv-val">{{ dados.provas_vida_ultimas_24h }}</p> 
            </div>
        </section>

        <hr>

        <section class="charts-grid">
            
            <div class="chart-container-small">
                <h3>üìä Movimenta√ß√£o Mensal</h3>
                <div class="chart-wrapper"><canvas id="mensalChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>üìå Prioridade Atual</h3>
                <div class="chart-wrapper"><canvas id="prioridadeChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>‚è≥ Dias M√©dios / Profissional</h3>
                <div class="chart-wrapper"><canvas id="diasChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>üìÖ Hist√≥rico Anual</h3>
                <div class="chart-wrapper"><canvas id="anualChart"></canvas></div>
            </div>

            <div class="chart-container-small">
                <h3>üìà Tend√™ncia de Prioridade</h3>
                <div class="chart-wrapper"><canvas id="tendenciaChart"></canvas></div>
            </div>

        </section>
    </main>

    <script>
        const d = {{ dados|tojson }};
        const commonOptions = { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } }
        };

        // 1. Movimenta√ß√£o Mensal
        new Chart(document.getElementById('mensalChart'), {
            type: 'line',
            data: {
                labels: d.movimentacao_mensal.labels,
                datasets: [
                    { label: 'Entradas', data: d.movimentacao_mensal.entradas, borderColor: '#007bff', tension: 0.3 },
                    { label: 'Altas', data: d.movimentacao_mensal.altas, borderColor: '#28a745', tension: 0.3 }
                ]
            },
            options: commonOptions
        });

        // 2. Prioridade (Rosca)
        new Chart(document.getElementById('prioridadeChart'), {
            type: 'doughnut',
            data: {
                labels: d.prioridade_data.labels,
                datasets: [{ 
                    data: d.prioridade_data.data, 
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'] 
                }]
            },
            options: commonOptions
        });

        // 3. Dias M√©dios (Barras Horizontal)
        new Chart(document.getElementById('diasChart'), {
            type: 'bar',
            data: {
                labels: d.dias_data.labels,
                datasets: [{ label: 'M√©dia de Dias', data: d.dias_data.data, backgroundColor: '#20b2aa' }]
            },
            options: { ...commonOptions, indexAxis: 'y' }
        });

        // 4. Hist√≥rico Anual
        new Chart(document.getElementById('anualChart'), {
            type: 'bar',
            data: {
                labels: d.movimentacao_anual.labels,
                datasets: [
                    { label: 'Entradas', data: d.movimentacao_anual.entradas, backgroundColor: '#007bff' },
                    { label: 'Altas', data: d.movimentacao_anual.altas, backgroundColor: '#28a745' }
                ]
            },
            options: commonOptions
        });

        // 5. Tend√™ncia de Prioridade
        new Chart(document.getElementById('tendenciaChart'), {
            type: 'line',
            data: {
                labels: d.movimentacao_mensal.labels,
                datasets: [
                    { label: 'Verde', data: d.prioridade_tendencia.verde, borderColor: '#28a745' },
                    { label: 'Amarelo', data: d.prioridade_tendencia.amarelo, borderColor: '#ffc107' },
                    { label: 'Vermelho', data: d.prioridade_tendencia.vermelho, borderColor: '#dc3545' }
                ]
            },
            options: commonOptions
        });

        function updateKpi(t, p) {
            fetch(`/api/kpi/${t}/${p}`).then(r => r.json()).then(data => {
                document.getElementById(`kpi-${t}-val`).innerText = data.valor;
            });
        }
    </script>
</body>
</html>