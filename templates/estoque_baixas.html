<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Hist√≥rico de Baixas | Sistema Hospitalar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="dark-mode" style="padding-top: 80px;">

    <header class="main-header" style="background: #181a1f; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; width: 100%; z-index: 1000;">
    
    <div class="nav-dropdown">
        <h2 onclick="toggleNavMenu()" style="cursor: pointer; margin: 0; display: flex; align-items: center; gap: 10px;" title="Clique para navegar entre m√≥dulos">
            üìä <span id="current-module">Baixa de Estoque</span> <span style="font-weight: 100; opacity: 0.6; font-size: 0.8em;">‚ñº</span>
        </h2>
        
        <div id="nav-menu-list" class="nav-menu-content card">
            <div class="menu-sep">NAVEGA√á√ÉO R√ÅPIDA</div>
            <a href="{{ url_for('dashboard') }}">üè† Dashboard (Home)</a>
            <a href="{{ url_for('pacientes') }}">üë• Pacientes Internados</a>
            <a href="{{ url_for('prontuario') }}">üìù Novo Prontu√°rio</a>
            
            <div class="menu-sep">GEST√ÉO E CL√çNICA</div>
            <a href="{{ url_for('estoque') }}">üì¶ Estoque de Medicamentos</a>
            <a href="{{ url_for('estoque_historico_baixas') }}">üìâ Hist√≥rico de Baixas de Medicamentos</a>
            <a href="{{ url_for('provas_vida_geral') }}">‚ù§Ô∏è Hist√≥rico de Provas de Vida</a>
            <a href="{{ url_for('arquivo') }}">üìÅ Arquivo (Altas)</a>
            <a href="{{ url_for('conversor') }}">‚öñÔ∏è Conversor de Medidas</a>
            
            {% if session.get('nivel') in ['admin', 'tecnico'] %}
                <div class="menu-sep">ADMINISTRA√á√ÉO</div>
                <a href="{{ url_for('gerenciar_usuarios') }}">üë§ Gerenciar Usu√°rios</a>
            {% endif %}
        </div>
    </div>

    <nav style="display: flex; align-items: center; gap: 20px;">
        <button id="theme-toggle" class="theme-toggle-btn" title="Alternar Modo de Cor">
            <span id="theme-icon" class="theme-icon-minimal" style="font-size: 1.2rem;"></span>
        </button>

        <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
        <a href="{{ url_for('sistema') }}" class="nav-link" style="color: #61afef; font-weight: bold;">Sistema</a>
        <a href="{{ url_for('logout') }}" style="color: #e06c75; font-weight: bold; text-decoration: none;" class="nav-link">Sair</a>
    </nav>
</header>


    <main class="estoque-container" style="padding: 20px; max-width: 1200px; margin: 0 auto;">
        
        <div class="page-title-area" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h2 style="color: #e06c75;"><i class="fas fa-file-invoice-dollar"></i> Relat√≥rio de Baixas e Perdas</h2>
            <button onclick="window.print()" class="btn-primary" style="background: #61afef;"><i class="fas fa-print"></i> Imprimir</button>
        </div>

        <div class="card" style="padding: 20px; background: #21252b; border-radius: 8px; display: flex; gap: 20px; margin-bottom: 20px;">
            <div style="flex: 2;">
                <input type="text" id="filtro_nome" onkeyup="filtrar()" placeholder="Filtrar por nome do medicamento..." 
                       style="width: 100%; padding: 12px; background: #181a1f; border: 1px solid #3e4451; color: white; border-radius: 5px;">
            </div>
            <div style="flex: 1;">
                <input type="date" id="filtro_data" onchange="filtrar()" 
                       style="width: 100%; padding: 12px; background: #181a1f; border: 1px solid #3e4451; color: white; border-radius: 5px;">
            </div>
        </div>

        <table class="estoque-table" id="tabela_baixas">
            <thead>
                <tr>
                    <th><i class="fas fa-calendar-alt"></i> Data/Hora</th>
                    <th><i class="fas fa-pills"></i> Medicamento</th>
                    <th><i class="fas fa-minus-circle"></i> Quantidade</th>
                    <th><i class="fas fa-comment-dots"></i> Motivo</th>
                    <th><i class="fas fa-user-shield"></i> Respons√°vel</th>
                </tr>
            </thead>
            <tbody>
                {% for baixa in baixas %}
                <tr class="item-row item-baixa">
                    <td class="col-data">{{ baixa.data_hora.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="col-nome"><strong>{{ baixa.nome_medicamento }}</strong></td>
                    <td style="color: #e06c75; font-weight: bold;">-{{ baixa.quantidade_removida }} {{ baixa.unidade }}</td>
                    <td><span class="status-badge" style="background: rgba(224, 108, 117, 0.2); color: #e06c75;">{{ baixa.motivo }}</span></td>
                    <td style="color: #61afef;">{{ baixa.usuario_baixa }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </main>

    <script>
    // 1. FUN√á√ÉO DO MENU DROPDOWN (ARRUMADA)
    function toggleNavMenu() {
        const menu = document.getElementById('nav-menu-list');
        if (menu) {
            // Verifica o estado atual e alterna
            if (menu.style.display === 'block') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
            }
        }
    }

    // 2. FECHAR MENU AO CLICAR FORA
    window.addEventListener('click', function(event) {
        const menu = document.getElementById('nav-menu-list');
        const trigger = document.querySelector('.nav-dropdown h2');
        
        // Se clicar fora do bot√£o e fora do menu, ele fecha
        if (menu && trigger && !trigger.contains(event.target) && !menu.contains(event.target)) {
            menu.style.display = 'none';
        }
    });

    // 3. FUN√á√ÉO DE FILTRO (MANTIDA)
    function filtrar() {
        let nome = document.getElementById('filtro_nome').value.toLowerCase();
        let data = document.getElementById('filtro_data').value;
        let linhas = document.querySelectorAll('.item-baixa');

        linhas.forEach(linha => {
            let textoNome = linha.querySelector('.col-nome').textContent.toLowerCase();
            let textoData = linha.querySelector('.col-data').textContent;
            let dataTabelaISO = textoData.split(' ')[0].split('/').reverse().join('-');
            
            let bateNome = textoNome.includes(nome);
            let bateData = data === "" || dataTabelaISO === data;

            linha.style.display = (bateNome && bateData) ? "" : "none";
        });
    }

    // 4. L√ìGICA DE TEMA (MANTIDA)
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');

    function refreshUI(isDark) {
        if (isDark) {
            document.body.classList.add('dark-mode');
            if (themeIcon) { themeIcon.innerHTML = '&#9728;'; themeIcon.style.color = '#ffcc00'; }
        } else {
            document.body.classList.remove('dark-mode');
            if (themeIcon) { themeIcon.innerHTML = '&#9789;'; themeIcon.style.color = '#333'; }
        }
    }

    const savedTheme = localStorage.getItem('theme') || 'dark';
    refreshUI(savedTheme === 'dark');

    if (themeToggle) {
        themeToggle.addEventListener('click', () => {
            const isNowDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isNowDark ? 'dark' : 'light');
            refreshUI(isNowDark);
        });
    }
</script>
</body>
</html>