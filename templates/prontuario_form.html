<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Novo Prontu√°rio | PEP</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .theme-icon-minimal { font-family: "Segoe UI Symbol", sans-serif; font-weight: 100; }
        .nav-link { text-decoration: none; color: inherit; transition: opacity 0.2s; }
        .nav-link:hover { opacity: 0.7; }
        .medication-item {
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.02);
        }
    </style>
</head>
<body class="dark-mode">
    
<header class="main-header" style="background: #181a1f; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; width: 100%; z-index: 1000;">
    
    <div class="nav-dropdown">
        <h2 onclick="toggleNavMenu()" style="cursor: pointer; margin: 0; display: flex; align-items: center; gap: 10px;" title="Clique para navegar entre m√≥dulos">
            üìä <span id="current-module">PEP</span> <span style="font-weight: 100; opacity: 0.6; font-size: 0.8em;">‚ñº</span>
        </h2>
        
        <div id="nav-menu-list" class="nav-menu-content card">
            <div class="menu-sep">NAVEGA√á√ÉO R√ÅPIDA</div>
            <a href="{{ url_for('dashboard') }}">üè† Dashboard (Home)</a>
            <a href="{{ url_for('pacientes') }}">üë• Pacientes Internados</a>
            <a href="{{ url_for('prontuario') }}">üìù Novo Prontu√°rio</a>
            
            <div class="menu-sep">GEST√ÉO E CL√çNICA</div>
            <a href="{{ url_for('estoque') }}">üì¶ Estoque de Medicamentos</a>
            <a href="{{ url_for('estoque_historico_baixas') }}">üìâ Hist√≥rico de Baixas</a>
            <a href="{{ url_for('provas_vida_geral') }}">‚ù§Ô∏è Hist√≥rico de Provas de Vida</a>
            <a href="{{ url_for('arquivo') }}">üìÅ Arquivo (Altas)</a>
            <a href="{{ url_for('conversor') }}">‚öñÔ∏è Conversor de Medidas</a>
            
            {% if session.get('nivel') in ['admin', 'tecnico'] %}
                <div class="menu-sep">ADMINISTRA√á√ÉO</div>
                <a href="{{ url_for('gerenciar_usuarios') }}">üë§ Gerenciar Usu√°rios</a>
            {% endif %}
        </div>
    </div>

    <nav style="display: flex; align-items: center; gap: 20px;">
        <button id="theme-toggle" class="theme-toggle-btn" title="Alternar Modo de Cor">
            <span id="theme-icon" class="theme-icon-minimal" style="font-size: 1.2rem;"></span>
        </button>

        <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
        <a href="{{ url_for('sistema') }}" class="nav-link" style="color: #61afef; font-weight: bold;">Sistema</a>
        <a href="{{ url_for('logout') }}" style="color: #e06c75; font-weight: bold; text-decoration: none;" class="nav-link">Sair</a>
    </nav>
</header>
    
    <main class="content-wrapper" style="padding: 20px;">
        <div class="prontuario-form-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <h3>Informa√ß√µes do Paciente</h3>
            <form action="{{ url_for('salvar_prontuario') }}" method="POST">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo:</label>
                        <input type="text" name="nome_paciente" placeholder="Ex: Jo√£o da Silva" required>
                    </div>
                    <div class="form-group">
                        <label>Data de Nascimento:</label>
                        <input type="date" name="data_nascimento" required>
                    </div>
                    <div class="form-group">
                        <label>Data/Hora Interna√ß√£o:</label>
                        <input type="datetime-local" name="hora_entrada" value="{{ agora }}" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label>CPF:</label>
                        <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" maxlength="14" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>CEP:</label>
                        <input type="text" id="cep" name="cep" placeholder="95780-000" maxlength="9">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label>Endere√ßo:</label>
                        <input type="text" id="endereco" name="endereco" placeholder="Rua, Avenida..." required>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Bairro:</label>
                        <input type="text" id="bairro" name="bairro" placeholder="Centro" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>N¬∫:</label>
                        <input type="text" id="numero" name="numero" placeholder="123">
                    </div>
                </div>
                
                <div class="section-header"><h3>Dados Cl√≠nicos e Triagem</h3></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>CID-10 Principal:</label>
                        <input type="text" name="cid_10" placeholder="Ex: I10 (Hipertens√£o)">
                    </div>
                    <div class="form-group">
                        <label>Prioridade de Aten√ß√£o:</label>
                        <select name="prioridade_atencao" required>
                            <option value="verde">Verde (N√£o Urgente)</option>
                            <option value="amarelo">Amarelo (Aten√ß√£o / Urg√™ncia)</option>
                            <option value="vermelho">Vermelho (Emerg√™ncia)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Procedimento / Motivo:</label>
                    <input type="text" name="procedimento" placeholder="Ex: Cirurgia Geral, Pneumonia, Crise Hipertensiva" required>
                </div>

                <div class="form-group">
                    <label>Observa√ß√µes / Anamnese Inicial:</label>
                    <textarea name="observacoes_entrada" rows="3" placeholder="Relate o estado inicial do paciente, alergias conhecidas e queixas principais..."></textarea>
                </div>

                <div class="section-header"><h3>Administra√ß√£o Inicial de Medicamento</h3></div>
                <div id="medication-container"></div>
                <button type="button" id="add-med-btn" class="add-med-button">Adicionar outro Medicamento (+)</button>

                <div class="action-buttons">
                    <button type="submit" class="btn-login" style="padding: 15px 30px;">Salvar Prontu√°rio</button>
                </div>
            </form>
        </div>
    </main>

<template id="medication-template">
    <div class="medication-item">
        <div class="form-row">
            <div class="form-group" style="flex: 3;">
                <label>Medicamento:</label>
                <select name="medicamento_entrada[]" class="medicamento-select" required>
                    <option value="">Selecione o medicamento dispon√≠vel...</option>
                    {% for med in medicamentos %}
                        <option value="{{ med.nome_medicamento }}">{{ med.nome_medicamento }} (Saldo: {{ med.quantidade }})</option>
                    {% endfor %}
                    <option value="outro">Outro (Especificar manualmente)</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Dose (Qtd):</label>
                <input type="number" step="0.01" name="dose[]" placeholder="Qtd" required min="0.01">
            </div>
            </div>
        </div>
</template>

    <script src="{{ url_for('static', filename='js/prontuario.js') }}"></script>
    <script src="{{ url_for('static', filename='js/cep_autofill.js') }}"></script>
    <script>
        // Tema e M√°scara CPF integrados
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        function refreshUI(isDark) {
            document.body.classList.toggle('dark-mode', isDark);
            themeIcon.innerHTML = isDark ? '&#9728;' : '&#9789;';
            themeIcon.style.color = isDark ? '#ffcc00' : '#333';
        }
        const savedTheme = localStorage.getItem('theme') || 'dark';
        refreshUI(savedTheme === 'dark');
        themeToggle.addEventListener('click', () => {
            const isNowDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isNowDark ? 'dark' : 'light');
            refreshUI(isNowDark);
        });

        document.getElementById('cpf').addEventListener('input', function (e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,3})(\d{0,2})/);
            e.target.value = !x[2] ? x[1] : x[1] + '.' + x[2] + (x[3] ? '.' + x[3] : '') + (x[4] ? '-' + x[4] : '');
        });
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>