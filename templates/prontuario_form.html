<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Módulo Prontuário</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <style>
        /* Estilo específico para o formulário */
        .prontuario-form-container { max-width: 800px; margin: 30px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .prontuario-form-container h3 { border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; color: #007bff; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-row > .form-group { flex: 1; }
        .form-group label { font-weight: bold; margin-bottom: 5px; display: block;}
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .checkbox-sn { display: flex; align-items: center; gap: 10px; }
        .action-buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; }
        /* Estilo para o botão de Prova de Vida */
        .btn-prova-vida { 
            background-color: #28a745; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            text-decoration: none; /* Para usar como link */
            text-align: center;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <h2>Módulo Prontuário</h2>
        <nav>
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('prontuario') }}" class="active">Prontuário</a> 
            <a href="{{ url_for('estoque') }}">Estoque</a> 
            <a href="{{ url_for('conversor') }}">Conversor</a> 
            <a href="{{ url_for('arquivo') }}">Arquivo</a> 
            {% if session.get('nivel') in ['admin', 'tecnico'] %}
                <a href="{{ url_for('gerenciar_usuarios') }}">Usuários</a>
            {% endif %}
            <a href="{{ url_for('logout') }}" class="btn-logout">Sair</a>
        </nav>
    </header>

    <main class="prontuario-form-container">
        <form action="{{ url_for('salvar_prontuario') }}" method="POST">
            
            <h3>Dados Pessoais e Entrada</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="nome_paciente">Nome do Paciente:</label>
                    <input type="text" id="nome_paciente" name="nome_paciente" required>
                </div>
                <div class="form-group">
                    <label for="data_nascimento">Data de Nascimento (dd-mm-aaaa):</label>
                    <input type="date" id="data_nascimento" name="data_nascimento" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="hora_entrada">Hora de Entrada:</label>
                    <input type="datetime-local" id="hora_entrada" name="hora_entrada" required>
                </div>
                <div class="form-group">
                    <label for="quem_deu_baixa">Profissional de Baixa (Entrada):</label>
                    <input type="text" id="quem_deu_baixa" name="quem_deu_baixa" value="{{ usuario }}" readonly>
                </div>
            </div>
            
            <h3>Endereço (Busca por CEP)</h3>
            <div class="form-row">
                <div class="form-group" style="flex: 0 0 30%;">
                    <label for="cep">CEP:</label>
                    <input type="text" id="cep" name="cep" maxlength="9" required> 
                </div>
                <div class="form-group" style="flex: 0 0 70%;">
                    <label for="endereco">Endereço:</label>
                    <input type="text" id="endereco" name="endereco" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="numero">Número:</label>
                    <input type="text" id="numero" name="numero" required>
                </div>
                <div class="form-group">
                    <label for="bairro">Bairro:</label>
                    <input type="text" id="bairro" name="bairro" required>
                </div>
                <div class="form-group">
                    <label for="cidade_uf">Cidade/UF:</label>
                    <input type="text" id="cidade_uf" name="cidade_uf" required readonly> 
                </div>
            </div>

            <h3>Procedimento e Medicação Inicial</h3>
            <div class="form-group">
                <label for="procedimento">Procedimento a ser realizado ou Motivo da Internação:</label>
                <textarea id="procedimento" name="procedimento" rows="3" required></textarea>
            </div>

            <div class="form-group">
                <label>Medicamento Tomado na Entrada (ou prescrito):</label>
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <select id="medicamento_entrada" name="medicamento_entrada">
                            <option value="">Nenhum/Não Aplicável</option>
                            <option value="Dipirona">Dipirona (Analgesia)</option>
                            <option value="Dramin">Dramin (Náusea/Vômito)</option>
                            <option value="Omeprazol">Omeprazol (Proteção Gástrica)</option>
                            <option value="Soro Fisiológico">Soro Fisiológico 0.9% (Hidratação)</option>
                            
                            {% for med in medicamentos %}
                                {% if med.nome_medicamento not in ['Dipirona', 'Dramin', 'Omeprazol', 'Soro Fisiológico'] %}
                                    <option value="{{ med.nome_medicamento }}">{{ med.nome_medicamento }}</option>
                                {% endif %}
                            {% endfor %}
                            <option value="outro">Outro (Especifique abaixo)</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="dose">Dose/Quantidade:</label>
                        <input type="number" step="0.01" id="dose" name="dose">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="checkbox-sn">
                            <input type="checkbox" id="se_necessario" name="se_necessario" value="S"> S/N (Se Necessário)
                        </label>
                    </div>
                </div>
                <div class="form-group" id="outro_medicamento_group" style="display:none; margin-top: 10px;">
                    <label for="outro_medicamento_nome">Nome do Outro Medicamento:</label>
                    <input type="text" id="outro_medicamento_nome" name="outro_medicamento_nome">
                </div>
            </div>
            
            <div class="action-buttons">
                <button type="submit" class="btn-login">Registrar Novo Prontuário</button>
                <a href="{{ url_for('prova_vida') }}" class="btn-prova-vida">
                    ➕ Adicionar Prova de Vida
                </a>
            </div>
        </form>
    </main>

    <script src="{{ url_for('static', filename='js/cep_autofill.js') }}"></script>
    <script>
        // Lógica de mostrar/esconder campo "Outro Medicamento"
        document.getElementById('medicamento_entrada').addEventListener('change', function() {
            var display = this.value === 'outro' ? 'block' : 'none';
            document.getElementById('outro_medicamento_group').style.display = display;
        });

        // Lógica de Preenchimento Automático do CEP (Se for implementado em cep_autofill.js)
        document.addEventListener('DOMContentLoaded', function() {
            var cepInput = document.getElementById('cep');
            if (cepInput) {
                cepInput.addEventListener('blur', function() {
                    // Remove caracteres não numéricos
                    var cep = this.value.replace(/\D/g, '');
                    if (cep.length === 8) {
                        fetch(`https://viacep.com.br/ws/${cep}/json/`)
                            .then(response => response.json())
                            .then(data => {
                                if (!("erro" in data)) {
                                    document.getElementById('endereco').value = data.logradouro || '';
                                    document.getElementById('bairro').value = data.bairro || '';
                                    document.getElementById('cidade_uf').value = `${data.localidade} / ${data.uf}` || '';
                                    document.getElementById('numero').focus(); // Foca no número após preenchimento
                                } else {
                                    alert("CEP não encontrado.");
                                }
                            })
                            .catch(error => console.error('Erro ao buscar CEP:', error));
                    }
                });
            }
        });
    </script>
</body>
</html>