<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Detalhes do Prontu√°rio | {{ paciente.nome }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .theme-icon-minimal { font-family: "Segoe UI Symbol", sans-serif; font-weight: 100; user-select: none; }
        .nav-link { text-decoration: none; color: inherit; transition: opacity 0.2s; }
        
        .pv-evolucao {
            background: rgba(97, 175, 239, 0.05);
            border-left: 4px solid #61afef;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-style: italic;
            color: var(--text-primary);
        }
        .dark-mode .pv-evolucao { background: rgba(255, 255, 255, 0.05); }

        .temp-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            background: rgba(224, 108, 117, 0.2);
            color: #e06c75;
        }

        .pv-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-top: 10px;
        }
        .btn-pv-edit { color: #61afef; text-decoration: none; font-size: 0.9em; font-weight: bold; }
        .btn-pv-delete { color: #e06c75; text-decoration: none; font-size: 0.9em; font-weight: bold; }

        /* Garantindo que o menu dropdown funcione visualmente */
        .nav-menu-content {
            display: none;
            position: absolute;
            background: #1c1f24;
            min-width: 250px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 1001;
            top: 60px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .nav-menu-content.show {
            display: block;
        }
    </style>
</head>
<body class="dark-mode">
    
    <header class="main-header" style="background: #181a1f; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; width: 100%; z-index: 1000;">
    
    <div class="nav-dropdown">
        <h2 onclick="toggleNavMenu()" style="cursor: pointer; margin: 0; display: flex; align-items: center; gap: 10px;" title="Clique para navegar entre m√≥dulos">
            üìä <span id="current-module">Dados do Paciente</span> <span style="font-weight: 100; opacity: 0.6; font-size: 0.8em;">‚ñº</span>
        </h2>
        
        <div id="nav-menu-list" class="nav-menu-content card">
            <div class="menu-sep">NAVEGA√á√ÉO R√ÅPIDA</div>
            <a href="{{ url_for('dashboard') }}">üè† Dashboard (Home)</a>
            <a href="{{ url_for('pacientes') }}">üë• Pacientes Internados</a>
            <a href="{{ url_for('prontuario') }}">üìù Novo Prontu√°rio</a>
            
            <div class="menu-sep">GEST√ÉO E CL√çNICA</div>
            <a href="{{ url_for('estoque') }}">üì¶ Estoque de Medicamentos</a>
            <a href="{{ url_for('estoque_historico_baixas') }}">üìâ Hist√≥rico de Baixas de Medicamentos</a>
            <a href="{{ url_for('provas_vida_geral') }}">‚ù§Ô∏è Hist√≥rico de Provas de Vida</a>
            <a href="{{ url_for('arquivo') }}">üìÅ Arquivo (Altas)</a>
            <a href="{{ url_for('conversor') }}">‚öñÔ∏è Conversor de Medidas</a>
            
            {% if session.get('nivel') in ['admin', 'tecnico'] %}
                <div class="menu-sep">ADMINISTRA√á√ÉO</div>
                <a href="{{ url_for('gerenciar_usuarios') }}">üë§ Gerenciar Usu√°rios</a>
            {% endif %}
        </div>
    </div>

    <nav style="display: flex; align-items: center; gap: 20px;">
        <button id="theme-toggle" class="theme-toggle-btn" title="Alternar Modo de Cor">
            <span id="theme-icon" class="theme-icon-minimal" style="font-size: 1.2rem;"></span>
        </button>

        <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
        <a href="{{ url_for('sistema') }}" class="nav-link" style="color: #61afef; font-weight: bold;">Sistema</a>
        <a href="{{ url_for('logout') }}" style="color: #e06c75; font-weight: bold; text-decoration: none;" class="nav-link">Sair</a>
    </nav>
</header>

    <main class="detalhes-container" style="padding: 20px; max-width: 1000px; margin: 80px auto 0;">
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Dados do Paciente</h3>
                <div style="display: flex; gap: 10px;">
                    {% if paciente.status == 'internado' %}
                         <a href="{{ url_for('prova_vida', paciente_id=paciente.id) }}" class="btn-login" style="background-color: #28a745; color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; font-weight: bold;">
                            Nova Prova de Vida
                        </a>
                     {% else %}
                        <span style="color: #e06c75; font-weight: bold; background: rgba(224, 108, 117, 0.1); padding: 10px; border-radius: 6px; border: 1px solid #e06c75;">
                             üö´ Registro em Arquivo (Alta)
                        </span>
                    {% endif %}
                 </div>
        </div>
        
        <div class="card" style="padding: 20px; margin-bottom: 30px;">
            <div><strong>Nome:</strong> {{ paciente.nome }}</div>
            <div><strong>Data de Nascimento:</strong> {{ paciente.data_nascimento.strftime('%d/%m/%Y') if paciente.data_nascimento else 'N/A' }}</div>
            <div><strong>CPF:</strong> {{ paciente.cpf }}</div>
            <div><strong>Status:</strong> <span class="badge nivel-{{ 'verde' if paciente.status == 'internado' else 'vermelho' }}">{{ paciente.status | upper }}</span></div>
        </div>

        <h3 class="section-header">Hist√≥rico Cl√≠nico ({{ provas_vida | length }} Registros)</h3>
        
        {% if provas_vida %}
        <div class="prova-vida-list">
            {% for pv in provas_vida %}
            <div class="prova-vida-item card" style="margin-bottom: 15px; padding: 15px; border-left: 5px solid #28a745;">
                <div class="pv-data" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
                    <span>üìÖ <strong>Data:</strong> {{ pv.data_hora.strftime('%d/%m/%Y %H:%M') if pv.data_hora else 'N/A' }}</span>
                    <span>üë®‚Äç‚öïÔ∏è <strong>Profissional:</strong> {{ pv.quem_efetuou }}</span>
                    <span>ü©∏ <strong>PA:</strong> {{ pv.pressao_arterial }}</span>
                    <span>üå°Ô∏è <strong>Temp:</strong> <span class="temp-badge">{{ pv.temperatura }}¬∞C</span></span>
                    <span>‚ù§Ô∏è <strong>FC:</strong> {{ pv.batimentos_cardiacos }} bpm</span>
                    <span>üíâ <strong>Glicose:</strong> {{ pv.glicose }} mg/dL</span>
                    <span>üí® <strong>SpO2:</strong> {{ pv.saturacao }}%</span>
                </div>

                {% if pv.evolucao %}
                <div class="pv-evolucao">
                    <strong>üìù Evolu√ß√£o:</strong> {{ pv.evolucao }}
                </div>
                {% endif %}

                {% if session.get('nivel') in ['admin', 'tecnico'] %}
                <div class="pv-actions">
                    <a href="{{ url_for('editar_prova_vida', pv_id=pv.id) }}" class="btn-pv-edit">‚úèÔ∏è Editar Registro</a>
                    <a href="{{ url_for('excluir_prova_vida', pv_id=pv.id) }}" class="btn-pv-delete" onclick="return confirm('Excluir este registro cl√≠nico permanentemente?')">üóëÔ∏è Excluir</a>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="card" style="padding: 20px; text-align: center; opacity: 0.6;">Nenhum registro encontrado.</p>
        {% endif %}

    </main>

    <script>
        // FUN√á√ÉO QUE ESTAVA FALTANDO PARA O MENU FUNCIONAR
        function toggleNavMenu() {
            const menu = document.getElementById('nav-menu-list');
            menu.classList.toggle('show');
        }

        // Fechar o menu se clicar fora dele
        window.onclick = function(event) {
            if (!event.target.matches('#current-module') && !event.target.closest('.nav-dropdown')) {
                const dropdowns = document.getElementsByClassName("nav-menu-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    let openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        function refreshUI(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                themeIcon.innerHTML = '&#9728;';
                themeIcon.style.color = '#ffcc00';
            } else {
                document.body.classList.remove('dark-mode');
                themeIcon.innerHTML = '&#9789;';
                themeIcon.style.color = '#333';
            }
        }

        const savedTheme = localStorage.getItem('theme') || 'dark';
        refreshUI(savedTheme === 'dark');

        themeToggle.addEventListener('click', () => {
            const isNowDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isNowDark ? 'dark' : 'light');
            refreshUI(isNowDark);
        });
    </script>
</body>
</html>